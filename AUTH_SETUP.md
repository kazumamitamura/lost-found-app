# èªè¨¼æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€å¿˜ã‚Œç‰©ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã®èªè¨¼æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—æ–¹æ³•ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## ã“ã®ã‚¢ãƒ—ãƒªã§ä½¿ã† Supabase ã®ãƒ†ãƒ¼ãƒ–ãƒ«

| ç”¨é€”           | ãƒ†ãƒ¼ãƒ–ãƒ«å           | èª¬æ˜ |
|----------------|----------------------|------|
| **ç™»éŒ²è€…ï¼ˆç®¡ç†è€…ï¼‰** | **`lost_registrants`** | ã“ã®ã‚¢ãƒ—ãƒªã«ç™»éŒ²ã—ãŸäººï¼ˆæ•™å“¡ãƒ»è·å“¡ãªã©ï¼‰ã‚’ç®¡ç†ã€‚ã“ã“ã«ãƒ¡ãƒ¼ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¦ã€ã‹ã¤ Supabase Auth ã§åŒã˜ãƒ¡ãƒ¼ãƒ«ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ã‚‹äººã ã‘ãŒç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™ã€‚ |
| å¿˜ã‚Œç‰©ãƒ‡ãƒ¼ã‚¿   | `lost_items`         | å¿˜ã‚Œç‰©ã®ä¸€è¦§ãƒ»è¿”å´çŠ¶æ…‹ãªã©ã€‚ |
| ç”»åƒ           | Storage ãƒã‚±ãƒƒãƒˆ `lost-images` | å¿˜ã‚Œç‰©ã®å†™çœŸã€‚ |

æ¥é ­èª `lost_` ã«ã‚ˆã‚Šã€ä»–ã®ã‚¢ãƒ—ãƒªï¼ˆåŒã˜ Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆï¼‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¨æ··åŒã—ã¾ã›ã‚“ã€‚

## æ¦‚è¦

ç®¡ç†ç”»é¢ï¼ˆç™»éŒ²ã€ç®¡ç†ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€ç™»éŒ²è€…ç®¡ç†ï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯ã€äº‹å‰ã«ç™»éŒ²ã•ã‚ŒãŸç®¡ç†è€…ã®ã¿ã«åˆ¶é™ã•ã‚Œã¦ã„ã¾ã™ã€‚

## 1. Supabase Authã®è¨­å®š

### 1-1. Emailèªè¨¼ã®æœ‰åŠ¹åŒ–

1. Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‚’é–‹ã
2. **Authentication** â†’ **Providers** ã‚’é¸æŠ
3. **Email** ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª
4. **Confirm email** ã‚’ **ç„¡åŠ¹** ã«ã™ã‚‹ï¼ˆå­¦æ ¡å†…ã§ã®ä½¿ç”¨ã‚’æƒ³å®šï¼‰
   - ã¾ãŸã¯æœ‰åŠ¹ã®ã¾ã¾ã«ã—ã¦ã€ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’å¿…é ˆã«ã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã™

### 1-2. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š

1. **Authentication** â†’ **Policies** ã‚’é¸æŠ
2. `lost_registrants` ãƒ†ãƒ¼ãƒ–ãƒ«ã®RLSãƒãƒªã‚·ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª

## 2. åˆå›ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ä½œæˆ

### æ–¹æ³•1: Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰ä½œæˆï¼ˆæ¨å¥¨ï¼‰

1. **Authentication** â†’ **Users** ã‚’é¸æŠ
2. **Add user** ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
3. ä»¥ä¸‹ã‚’å…¥åŠ›ï¼š
   - **Email**: ç®¡ç†è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   - **Password**: å®‰å…¨ãªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆ8æ–‡å­—ä»¥ä¸Šæ¨å¥¨ï¼‰
   - **Auto Confirm User**: âœ… ãƒã‚§ãƒƒã‚¯ã‚’å…¥ã‚Œã‚‹
4. **Create user** ã‚’ã‚¯ãƒªãƒƒã‚¯

5. æ¬¡ã«ã€**ç™»éŒ²è€…ãƒ†ãƒ¼ãƒ–ãƒ«** `lost_registrants` ã«ã‚‚åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ç™»éŒ²ï¼š
   - **Database** â†’ **Table Editor** â†’ `lost_registrants` ã‚’é¸æŠ
   - **Insert row** ã‚’ã‚¯ãƒªãƒƒã‚¯
   - **name**: ç®¡ç†è€…å
   - **email**: Authã§ä½œæˆã—ãŸã®ã¨åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   - **role**: æ•™å“¡ï¼ˆã¾ãŸã¯è·å“¡ãƒ»ãã®ä»–ï¼‰
   - **Save** ã‚’ã‚¯ãƒªãƒƒã‚¯

### æ–¹æ³•2: SQLã§ä¸€æ‹¬ä½œæˆ

ä»¥ä¸‹ã®SQLã‚’å®Ÿè¡Œã—ã¦ã€è¤‡æ•°ã®ç®¡ç†è€…ã‚’ä¸€åº¦ã«è¨­å®šã§ãã¾ã™ï¼š

```sql
-- 1. lost_registrants ãƒ†ãƒ¼ãƒ–ãƒ«ã«ç®¡ç†è€…ã‚’è¿½åŠ ï¼ˆrole ã¯ 'æ•™å“¡'/'è·å“¡'/'ãã®ä»–' ã®ã„ãšã‚Œã‹ï¼‰
INSERT INTO lost_registrants (name, email, role, notes)
VALUES
  ('å±±ç”°å¤ªéƒ', 'yamada@school.com', 'æ•™å“¡', 'ç®¡ç†è€…'),
  ('ä½è—¤èŠ±å­', 'sato@school.com', 'æ•™å“¡', 'ç®¡ç†è€…'),
  ('éˆ´æœ¨æ¬¡éƒ', 'suzuki@school.com', 'æ•™å“¡', 'ç®¡ç†è€…');

-- 2. Supabase Authã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã€Supabaseãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã‹ã‚‰æ‰‹å‹•ã§ä½œæˆã™ã‚‹ã‹ã€
--    æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è‡ªå‹•ä½œæˆã•ã‚Œã‚‹ã‚ˆã†ã«è¨­å®šã—ã¾ã™
```

## 3. è‡ªå‹•ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

åˆå›ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è‡ªå‹•çš„ã«Authãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹å ´åˆã¯ã€ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã§ãã¾ã™ã€‚

### ç®¡ç†è€…ã«ã‚ˆã‚‹æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆæ©Ÿèƒ½

`app/admin/registrants/page.tsx` ã«ä»¥ä¸‹ã®æ©Ÿèƒ½ã‚’è¿½åŠ ï¼š

1. ç™»éŒ²è€…ã®è¿½åŠ æ™‚ã«ã€Supabase Authã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚è‡ªå‹•ä½œæˆ
2. åˆå›ãƒ­ã‚°ã‚¤ãƒ³ç”¨ã®æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡

ã‚³ãƒ¼ãƒ‰ä¾‹ï¼š

```typescript
// ç™»éŒ²è€…è¿½åŠ æ™‚ã«Authãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚ä½œæˆ
const { data: authUser, error: authError } = await supabase.auth.admin.createUser({
  email: newEmail,
  password: temporaryPassword, // ä¸€æ™‚ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
  email_confirm: true, // ãƒ¡ãƒ¼ãƒ«ç¢ºèªã‚’ã‚¹ã‚­ãƒƒãƒ—
});

// ã¾ãŸã¯ã€æ‹›å¾…ãƒ¡ãƒ¼ãƒ«ã‚’é€ä¿¡
const { data, error } = await supabase.auth.admin.inviteUserByEmail(newEmail);
```

## 4. ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

### ãƒ¦ãƒ¼ã‚¶ãƒ¼å´ã®ãƒ•ãƒ­ãƒ¼

1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ŒğŸ“ ç™»éŒ²ã€ã¾ãŸã¯ã€ŒğŸ“Š ç®¡ç†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
2. è‡ªå‹•çš„ã« `/admin/login` ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãƒ­ã‚°ã‚¤ãƒ³
4. èªè¨¼æˆåŠŸå¾Œã€å…ƒã®ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹

### èªè¨¼ãƒã‚§ãƒƒã‚¯ã®æµã‚Œ

```
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹
    â†“
ProtectedRoute ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒèªè¨¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
    â†“
â”Œâ”€ èªè¨¼æ¸ˆã¿ â†’ ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
â””â”€ æœªèªè¨¼ â†’ /admin/login ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    â†“
ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
    â†“
lost_registrants ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç™»éŒ²è€…ã¨ã—ã¦å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    â†“
â”Œâ”€ ç™»éŒ²è€… â†’ ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
â””â”€ æœªç™»éŒ² â†’ ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
```

## 5. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸå ´åˆã®æ©Ÿèƒ½ã‚’è¿½åŠ ã™ã‚‹å ´åˆï¼š

### 5-1. Supabaseè¨­å®š

1. **Authentication** â†’ **Email Templates** ã‚’é¸æŠ
2. **Reset Password** ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç¢ºèªãƒ»ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º

### 5-2. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªã‚»ãƒƒãƒˆç”»é¢ã®è¿½åŠ 

`app/admin/forgot-password/page.tsx` ã‚’ä½œæˆï¼š

```typescript
const handleResetPassword = async (email: string) => {
  const { error } = await supabase.auth.resetPasswordForEmail(email, {
    redirectTo: `${window.location.origin}/admin/reset-password`,
  });
  
  if (error) {
    // ã‚¨ãƒ©ãƒ¼å‡¦ç†
  } else {
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
  }
};
```

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 6-1. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒªã‚·ãƒ¼

- æœ€ä½8æ–‡å­—ä»¥ä¸Š
- å¤§æ–‡å­—ãƒ»å°æ–‡å­—ãƒ»æ•°å­—ã‚’å«ã‚€
- å®šæœŸçš„ãªå¤‰æ›´ã‚’æ¨å¥¨

### 6-2. RLSãƒãƒªã‚·ãƒ¼ã®ç¢ºèª

ä»¥ä¸‹ã®SQLã§ã€é©åˆ‡ãªRLSãƒãƒªã‚·ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªï¼š

```sql
-- lost_registrants ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒãƒªã‚·ãƒ¼ç¢ºèª
SELECT * FROM pg_policies WHERE tablename = 'lost_registrants';

-- å¿…è¦ã«å¿œã˜ã¦ã€èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´
DROP POLICY IF EXISTS lost_registrants_select_public ON lost_registrants;
DROP POLICY IF EXISTS lost_registrants_insert_public ON lost_registrants;
DROP POLICY IF EXISTS lost_registrants_update_public ON lost_registrants;
DROP POLICY IF EXISTS lost_registrants_delete_public ON lost_registrants;

-- èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ãŒã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
CREATE POLICY lost_registrants_select_authenticated ON lost_registrants
  FOR SELECT TO authenticated USING (true);

CREATE POLICY lost_registrants_insert_authenticated ON lost_registrants
  FOR INSERT TO authenticated WITH CHECK (true);

CREATE POLICY lost_registrants_update_authenticated ON lost_registrants
  FOR UPDATE TO authenticated USING (true);

CREATE POLICY lost_registrants_delete_authenticated ON lost_registrants
  FOR DELETE TO authenticated USING (true);
```

## 7. ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ãƒ­ã‚°ã‚¤ãƒ³ã§ããªã„

1. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„**
   - Supabase Dashboard â†’ Database â†’ lost_registrants ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç¢ºèª
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

2. **Authãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã•ã‚Œã¦ã„ãªã„**
   - Supabase Dashboard â†’ Authentication â†’ Users ã‚’ç¢ºèª
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª

3. **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé–“é•ã£ã¦ã„ã‚‹**
   - Supabase Dashboard â†’ Authentication â†’ Users ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ
   - **Reset password** ã§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ

### ãƒ­ã‚°ã‚¤ãƒ³å¾Œã™ãã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã‚‹

- ãƒ–ãƒ©ã‚¦ã‚¶ã®CookieãŒç„¡åŠ¹ã«ãªã£ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™
- ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§Cookieã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„

### ã€Œç™»éŒ²ã•ã‚Œã¦ã„ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ã™ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹

- `lost_registrants` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
- ç®¡ç†è€…ã«é€£çµ¡ã—ã¦ç™»éŒ²ã—ã¦ã‚‚ã‚‰ã£ã¦ãã ã•ã„

## 8. åˆå›ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

- [ ] Supabase AuthãŒæœ‰åŠ¹ã«ãªã£ã¦ã„ã‚‹
- [ ] åˆå›ç®¡ç†è€…ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ï¼ˆAuth + lost_registrantsï¼‰
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆ/admin/loginï¼‰ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [ ] ãƒ­ã‚°ã‚¤ãƒ³å¾Œã€ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
- [ ] ãƒ­ã‚°ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ãŒè¡¨ç¤ºã•ã‚Œã€æ©Ÿèƒ½ã™ã‚‹
- [ ] æœªèªè¨¼çŠ¶æ…‹ã§ç®¡ç†ç”»é¢ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã€ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹

## ã¾ã¨ã‚

èªè¨¼æ©Ÿèƒ½ã«ã‚ˆã‚Šã€ä»¥ä¸‹ãŒå®Ÿç¾ã•ã‚Œã¾ã™ï¼š

- âœ… ç®¡ç†ç”»é¢ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹åˆ¶é™
- âœ… äº‹å‰ç™»éŒ²ã•ã‚ŒãŸç®¡ç†è€…ã®ã¿ãŒæ“ä½œå¯èƒ½
- âœ… ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ­ã‚°ã‚¤ãƒ³ãƒ»ãƒ­ã‚°ã‚¢ã‚¦ãƒˆæ©Ÿèƒ½
- âœ… æ¤œç´¢ãƒšãƒ¼ã‚¸ã¯èª°ã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼ˆç”Ÿå¾’ç”¨ï¼‰

ä½•ã‹å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ã€ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‚ç…§ã—ã¦ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
